<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:Anf.Avalon.ViewModels"
             xmlns:s="using:Avalonia.Controls.PanAndZoom"
             xmlns:kwc="using:Anf"
             x:Name="VisitingView"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="Anf.Avalon.Views.VisitingView">
  <Design.DataContext>
    <vm:AvalonVisitingViewModel/>
  </Design.DataContext>
  <UserControl.Resources>
    <ContextMenu x:Key="ControlMenu">
      <MenuItem Header="{Binding DataContext.CurrentChapter.Title,ElementName=Rep}" IsEnabled="False"/>
      <MenuItem Header="复制">
        <MenuItem Header="实体" Command="{Binding DataContext.CopyComicEntityCommand,ElementName=Rep}"/>
        <MenuItem Header="地址" Command="{Binding DataContext.CopyComicCommand,ElementName=Rep}"/>
        <MenuItem Header="章节" Command="{Binding DataContext.CopyChapterCommand,ElementName=Rep}"/>
      </MenuItem>
      <MenuItem Header="打开">
        <MenuItem Header="漫画" Command="{Binding DataContext.OpenComicCommand,ElementName=Rep}"/>
        <MenuItem Header="章节" Command="{Binding DataContext.OpenChapterCommand,ElementName=Rep}"/>
      </MenuItem>
      <MenuItem Header="控制">
        <MenuItem Header="上一章" Command="{Binding DataContext.PrevChapterCommand,ElementName=Rep}"/>
        <MenuItem Header="下一章" Command="{Binding DataContext.NextChapterCommand,ElementName=Rep}"/>
      </MenuItem>
      <MenuItem Header="-"/>
      <MenuItem Header="保存" CommandParameter="{Binding}" Command="{Binding DataContext.SaveImageCommand,ElementName=Rep}"></MenuItem>
      <MenuItem Header="重载" Command="{Binding ReLoadCommand}"/>
    </ContextMenu>
  </UserControl.Resources>
  <Grid>
    <Carousel x:Name="Car"
              Items="{Binding Resources}"
              Background="{x:Null}"
              IsVisible="{Binding Transverse}"
              SelectedItem="{Binding SelectedResource,Mode=TwoWay}">
      <Carousel.ItemTemplate>
        <DataTemplate>
          <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
            <s:ZoomBorder EnableZoom="{Binding DataContext.EnableZoom,ElementName=Car,Mode=TwoWay}"
                          EnableConstrains="{Binding DataContext.EnableConstrains,ElementName=Car,Mode=TwoWay}"
                          EnableGestureZoom="{Binding DataContext.EnableGesture,ElementName=Car}"
                          EnableGestureRotation="{Binding DataContext.EnableGesture,ElementName=Car}"
                          EnableGestureTranslation="{Binding DataContext.EnableGesture,ElementName=Car}"
                          ZoomSpeed="{Binding DataContext.ZoomSpeed,ElementName=Car,Mode=TwoWay}"
                          Stretch="{Binding DataContext.StretchMode,ElementName=Car,Mode=TwoWay}"
                          MinWidth="{Binding DataContext.MinWidth,ElementName=Car}"
                          MinHeight="{Binding DataContext.MinHeight,ElementName=Car}">
              <Grid>
                <Border IsVisible="{Binding LoadSucceed}" ContextMenu="{StaticResource ControlMenu}">
                  <Image Stretch="None" Source="{Binding Resource}" MinHeight="200"></Image>
                </Border>
                <StackPanel IsVisible="{Binding HasException}" Orientation="Vertical">
                  <TextBlock VerticalAlignment="Center" Text="{Binding Exception}" TextWrapping="Wrap" MaxHeight="400">
                    <ToolTip.Tip>
                      <TextBlock Text="{Binding Exception}"/>
                    </ToolTip.Tip>
                  </TextBlock>
                  <Button MaxWidth="200" Content="Reload" Command="{Binding LoadCommand}" Margin="0,10,0,0"/>
                </StackPanel>
                <StackPanel IsVisible="{Binding Loading}" Orientation="Vertical">
                  <ProgressBar IsIndeterminate="True" Margin="20,0"/>
                </StackPanel>
              </Grid>
            </s:ZoomBorder>
          </ScrollViewer>
        </DataTemplate>
      </Carousel.ItemTemplate>
    </Carousel>
    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" IsVisible="{Binding Transverse,Converter={StaticResource RevBoolConverter}}">
      <ItemsRepeater Name="Rep"
                     Background="{x:Null}"
                     Items="{Binding Resources}">
        <ItemsRepeater.ItemTemplate>
          <DataTemplate>
            <Grid>
              <Border IsVisible="{Binding LoadSucceed}"  ContextMenu="{StaticResource ControlMenu}">
                <Image Stretch="None" Source="{Binding Resource}" MinHeight="200"></Image>
              </Border>
              <StackPanel IsVisible="{Binding HasException}" Orientation="Vertical">
                <TextBlock VerticalAlignment="Center" Text="{Binding Exception}" TextWrapping="Wrap" MaxHeight="400">
                  <ToolTip.Tip>
                    <TextBlock Text="{Binding Exception}"/>
                  </ToolTip.Tip>
                </TextBlock>
                <Button MaxWidth="200" Content="Reload" Command="{Binding LoadCommand}" Margin="0,10,0,0"/>
              </StackPanel>
              <StackPanel IsVisible="{Binding Loading}" Orientation="Vertical">
                <ProgressBar IsIndeterminate="True" Margin="20,0"/>
              </StackPanel>
            </Grid>
          </DataTemplate>
        </ItemsRepeater.ItemTemplate>
      </ItemsRepeater>
    </ScrollViewer>

    <Border VerticalAlignment="Bottom" HorizontalAlignment="Left" Grid.RowSpan="2" Background="Gray" Padding="8,4" CornerRadius="8" Margin="4,8">
      <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
        <StackPanel.Resources>
          <Style x:Key="Tbx" Selector="TextBlock">
            <Setter Property="FontSize" Value="10"/>
          </Style>
        </StackPanel.Resources>
        <TextBlock Text="{Binding CurrentChapter.Title}"/>
        <TextBlock>(</TextBlock>
        <TextBlock Text="{Binding CurrentPageCursor.CurrentIndex,Converter={StaticResource AddConverter}}"></TextBlock>
        <TextBlock>/</TextBlock>
        <TextBlock Text="{Binding CurrentPageCursor.Count}"></TextBlock>
        <TextBlock>)</TextBlock>
      </StackPanel>
    </Border>

    <Border IsVisible="{Binding IsLoading}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
      <ExperimentalAcrylicBorder>
        <ExperimentalAcrylicBorder.Material>
          <ExperimentalAcrylicMaterial TintColor="Blue" MaterialOpacity="0.8" TintOpacity="0.87" />
        </ExperimentalAcrylicBorder.Material>
        <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="20,0">
          <StackPanel.Resources>
            <Thickness x:Key="ItemMargin">0,20,0,0</Thickness>
          </StackPanel.Resources>
          <Image Height="300" Source="{Binding LogoImage}" HorizontalAlignment="Center" Margin="{StaticResource ItemMargin}"/>
          <TextBlock FontSize="22" Text="{Binding Name}" HorizontalAlignment="Center" Margin="{StaticResource ItemMargin}"/>
          <ProgressBar IsIndeterminate="True" HorizontalAlignment="Stretch" Margin="{StaticResource ItemMargin}"/>
        </StackPanel>
      </ExperimentalAcrylicBorder>
    </Border>
  </Grid>
</UserControl>
